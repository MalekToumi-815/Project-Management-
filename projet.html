<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workify | Projet</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" type="image/png" href="images/logo.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3a0ca3;
      --accent-color: #4cc9f0;
      --text-dark: #2b2d42;
      --text-light: #6c757d;
      --border-color: #e9ecef;
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
      --transition: all 0.3s ease;
    }

    body {
      color: var(--text-dark);
      background:
        radial-gradient(1200px circle at 0% -10%, rgba(76, 201, 240, 0.18), rgba(76, 201, 240, 0) 60%),
        radial-gradient(1000px circle at 100% 110%, rgba(67, 97, 238, 0.12), rgba(67, 97, 238, 0) 55%),
        linear-gradient(135deg, #eef2ff 0%, #e9efff 50%, #e6e9ff 100%);
      background-attachment: fixed, fixed, fixed;
      min-height: 100vh;
      padding: 0 28px 28px;
    }

    .container { max-width: 1200px; margin: 0 auto; }

    /* Layout: header on top + board */
    .layout { display: grid; grid-template-columns: 1fr; gap: 22px; align-items: start; }

    /* Sidebar */
    /* Header bar */
    .header-bar {
      background: #fff;
      /* Full-bleed header (ignore page gutters) */
      width: 100vw;
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      border: none;
      border-bottom: 1px solid var(--border-color);
      border-radius: 0;
      box-shadow: none;
      position: sticky;
      top: 0;
      z-index: 1000;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .header-left { display: flex; align-items: center; gap: 16px; flex: 1; min-width: 0; }
    .header-logo { width: 160px; max-width: 25vw; height: auto; display: block; filter: drop-shadow(0 14px 28px rgba(67,97,238,0.35)); }
    .header-info { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; min-width: 0; }
    .header-title { font-size: 1.8rem; font-weight: 800; color: var(--text-dark); white-space: nowrap; }
    .header-desc { color: var(--text-light); max-width: 40ch; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .header-meta { display: flex; align-items: center; gap: 12px; color: var(--text-light); font-size: 0.95rem; }
    .header-meta .meta-row { display: inline-flex; align-items: center; gap: 6px; }
    .header-meta i { color: var(--primary-color); }
    .header-right { display: flex; align-items: center; gap: 10px; }
    .btn { padding: 10px 16px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; transition: var(--transition); }
    .btn-primary { background-color: var(--primary-color); color: #fff; box-shadow: 0 6px 20px rgba(67,97,238,0.25); }
    .btn-primary:hover { transform: translateY(-2px); background-color: var(--secondary-color); }
    .icon-btn { width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; border-radius: 10px; border: 1px solid var(--border-color); background: #fff; color: var(--primary-color); box-shadow: var(--shadow); transition: var(--transition); }
    .icon-btn:hover { background: var(--accent-color); color: #fff; transform: translateY(-2px); }

    /* Board columns */
    .board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    .list {
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .list-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 14px;
      font-weight: 700;
      color: #fff;
    }
    .list-header i { opacity: 0.9; }

    .list-content { padding: 12px; min-height: 160px; color: var(--text-light); font-size: 0.95rem; }

    /* Header colors */
    .todo { background: linear-gradient(135deg, #4361ee, #3a0ca3); }
    .progress { background: linear-gradient(135deg, #f4a261, #e76f51); }
    .verify { background: linear-gradient(135deg, #6a4c93, #b565f1); }
    .done { background: linear-gradient(135deg, #2ab673, #0f9d58); }

    /* Responsive */
    @media (max-width: 1000px) {
      .layout { grid-template-columns: 1fr; }
      .board { grid-template-columns: repeat(2, 1fr); }
      .header-logo { width: 140px; }
    }
    @media (max-width: 560px) {
      .board { grid-template-columns: 1fr; }
      .header-info { flex-direction: column; align-items: flex-start; gap: 6px; }
      .header-desc { max-width: 100%; }
    }

    /* Member sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      right: -400px; /* Hidden by default */
      width: 360px;
      height: 100%;
      background: #fff;
      box-shadow: -10px 0 30px rgba(0,0,0,0.1);
      transition: right 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      z-index: 1100;
      display: flex;
      flex-direction: column;
    }
    .sidebar.open { right: 0; }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border-color);
    }
    .sidebar-title { font-size: 1.2rem; font-weight: 700; }
    .sidebar-close { font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
    .sidebar-search {
      padding: 0 12px 12px;
      border-bottom: 1px solid var(--border-color);
    }
    .sidebar-search input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.95rem;
    }
    .sidebar-content { flex: 1; overflow-y: auto; padding: 12px; }
    .member-list { list-style: none; }
    .member-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 8px;
      transition: background 0.2s ease;
    }
    .member-item:hover { background: #f7f9fc; }
    .member-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 12px; }
    .member-info { flex: 1; }
    .member-name { font-weight: 600; }
    .member-role { font-size: 0.85rem; color: var(--text-light); }
    .author-tag { background: var(--accent-color); color: #fff; font-size: 0.75rem; padding: 2px 6px; border-radius: 6px; margin-left: 8px; }
    .kick-btn { padding: 6px 12px; font-size: 0.85rem; background: #ffebee; color: #c62828; border: none; border-radius: 8px; cursor: pointer; }
    .kick-btn:hover { background: #ffcdd2; }

    /* Chat Sidebar */
    .chat-sidebar {
      position: fixed;
      top: 0;
      right: -400px; /* Hidden by default */
      width: 360px;
      height: 100%;
      background: #fff;
      box-shadow: -10px 0 30px rgba(0,0,0,0.1);
      transition: right 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      z-index: 1100;
      display: flex;
      flex-direction: column;
    }
    .chat-sidebar.open { right: 0; }
    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border-color);
    }
    .chat-title { font-size: 1.2rem; font-weight: 700; }
    .chat-close { font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
    .chat-messages { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; }
    .message-list { list-style: none; padding: 0; margin-top: auto; }
    .message-item {
      display: flex;
      margin-bottom: 12px;
    }
    .message-avatar { width: 35px; height: 35px; border-radius: 50%; background: var(--secondary-color); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 10px; flex-shrink: 0; }
    .message-content { display: flex; flex-direction: column; }
    .message-author { font-weight: 600; font-size: 0.9rem; }
    .message-text { background: #f1f3f5; padding: 8px 12px; border-radius: 12px; font-size: 0.95rem; }
    .message-date { font-size: 0.75rem; color: var(--text-light); margin-top: 4px; }
    .chat-input-form { display: flex; padding: 10px; border-top: 1px solid var(--border-color); gap: 8px; }
    .chat-input { flex: 1; border: 1px solid var(--border-color); border-radius: 10px; padding: 10px; font-size: 1rem; }
    .send-btn { width: 40px; height: 40px; flex-shrink: 0; }

    /* Edit Dialog */
    .dialog-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1200;
      display: none; /* Hidden by default */
      align-items: center;
      justify-content: center;
    }
    .dialog-backdrop.open { display: flex; }
    .dialog {
      background: #fff;
      border-radius: var(--radius);
      padding: 24px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }
    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .dialog-title { font-size: 1.5rem; font-weight: 700; }
    .dialog-close { font-size: 1.8rem; cursor: pointer; color: var(--text-light); }
    .dialog-form .form-group { margin-bottom: 16px; }
    .dialog-form label { display: block; font-weight: 600; margin-bottom: 8px; }
    .dialog-form .form-control {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-size: 1rem;
    }
    .dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 24px;
    }

    /* Task Card */
    .task-card {
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border-left: 5px solid var(--primary-color);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.09);
    }
    .task-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-dark);
    }
    .task-deadline {
      font-size: 0.85rem;
      color: var(--text-light);
    }
    .task-card.dragging {
      opacity: 0.5;
    }
    .list-content.drag-over {
      background: rgba(67, 97, 238, 0.05);
    }

    /* Task Details Sidebar */
    .task-details-sidebar {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      width: 850px;
      max-width: 95vw;
      max-height: 85vh;
      background: #fff;
      box-shadow: 0 10px 50px rgba(0,0,0,0.2);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      z-index: 1100;
      display: flex;
      flex-direction: column;
      border-radius: 12px;
      opacity: 0;
      pointer-events: none;
    }
    .task-details-sidebar.open { 
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      pointer-events: all;
    }
    .task-details-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border-color);
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-radius: 12px 12px 0 0;
    }
    .task-details-header-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .task-delete-btn {
      font-size: 1.5rem;
      cursor: pointer;
      color: white;
      opacity: 0.9;
    }
    .task-delete-btn:hover { opacity: 1; color: #fee; }
    .task-details-title { font-size: 1.2rem; font-weight: 700; }
    .task-details-close { font-size: 1.5rem; cursor: pointer; color: white; opacity: 0.9; }
    .task-details-close:hover { opacity: 1; }
    .task-details-header .edit-icon { 
      font-size: 1.5rem; 
      cursor: pointer; 
      color: white; 
      opacity: 0.9;
      margin-right: 0 !important;
    }
    .task-details-header .edit-icon:hover { opacity: 1; color: white; }
    .task-details-body {
      flex: 1;
      overflow: hidden;
      display: grid;
      grid-template-columns: 1fr 320px;
    }
    .task-details-left {
      padding: 20px;
      overflow-y: auto;
      border-right: 1px solid var(--border-color);
    }
    .task-main-content { display: flex; flex-direction: column; gap: 16px; }
    .task-field {
      padding: 12px;
      background: var(--light);
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }
    .task-field-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .task-field-value {
      font-size: 0.95rem;
      color: var(--text-dark);
      word-break: break-word;
    }
    .task-field-input {
      width: 100%;
      padding: 8px 12px;
      font-size: 0.95rem;
      border: 2px solid var(--primary-color);
      border-radius: 6px;
      font-family: inherit;
      background: white;
      color: var(--text-dark);
    }
    .task-field-textarea {
      width: 100%;
      padding: 8px 12px;
      font-size: 0.95rem;
      border: 2px solid var(--primary-color);
      border-radius: 6px;
      font-family: inherit;
      background: white;
      color: var(--text-dark);
      resize: vertical;
      min-height: 80px;
    }
    .edit-icon {
      cursor: pointer;
      color: var(--primary-color);
      font-size: 0.9rem;
    }
    .edit-icon:hover { color: var(--secondary-color); }
    .task-state-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .task-state-todo { background: #dbeafe; color: #1e40af; }
    .task-state-progress { background: #fed7aa; color: #c2410c; }
    .task-state-verify { background: #e9d5ff; color: #6b21a8; }
    .task-state-done { background: #d1fae5; color: #065f46; }
    .task-priority-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .task-priority-1 { background: #d1fae5; color: #065f46; }
    .task-priority-2 { background: #dbeafe; color: #1e40af; }
    .task-priority-3 { background: #fee2e2; color: #991b1b; }
    .task-assignees {
      border-top: 2px solid var(--border-color);
      padding-top: 16px;
    }
    .assignees-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 12px;
    }
    #taskAssigneesList {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .assignee-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 8px;
      background: var(--light);
    }
    .assignee-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.8rem;
    }
    .assignee-name {
      font-size: 0.9rem;
      color: var(--text-dark);
    }
    .task-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .btn-save {
      background: #10b981;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-save:hover { background: #059669; }
    .btn-cancel {
      background: #ef4444;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-cancel:hover { background: #dc2626; }
    
    /* Assignment Panel */
    .task-details-right {
      background: #fafbfc;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .assignment-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      background: white;
    }
    .assignment-header h4 {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text-dark);
      margin: 0;
    }
    .assignment-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    .assignment-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: white;
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }
    .assignment-item:hover {
      border-color: var(--primary-color);
      box-shadow: 0 2px 8px rgba(67, 97, 238, 0.1);
    }
    .assignment-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary-color);
      flex-shrink: 0;
    }
    .assignment-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    .assignment-name {
      flex: 1;
      font-size: 0.85rem;
      color: var(--text-dark);
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .assignment-footer {
      padding: 12px;
      border-top: 1px solid var(--border-color);
      background: white;
    }
    .btn-assign {
      width: 100%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-assign:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
    }
    .btn-assign:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="layout">
      <!-- Header bar with project details on the left, controls on the right -->
      <header class="header-bar" id="projectHeader">
        <div class="header-left">
          <img src="images/logo.png" alt="Workify" class="header-logo" />
          <div class="header-info">
            <div class="header-title" id="pTitle">Projet</div>
            <div class="header-desc" id="pDesc">Description du projet...</div>
            <div class="header-meta">
              <div class="meta-row"><i class="fas fa-user"></i><span id="pAuthor">Auteur: —</span></div>
              <div class="meta-row"><i class="fas fa-calendar-alt"></i><span id="pDate">Créé le: —</span></div>
              <div class="meta-row"><i class="fas fa-hashtag"></i><span id="pCode">Join Code: —</span></div>
            </div>
          </div>
        </div>
        <div class="header-right" id="headerControls">
          <button class="btn btn-primary" id="btnCreateTask"><i class="fas fa-plus"></i> Create Task</button>
          <button class="icon-btn" id="btnEdit" aria-label="Edit Project"><i class="fas fa-pencil-alt"></i></button>
          <button class="icon-btn" id="btnMembers" aria-label="Members"><i class="fas fa-users"></i></button>
          <button class="icon-btn" id="btnChat" aria-label="Chat"><i class="fas fa-comments"></i></button>
        </div>
      </header>

      <!-- Board: 4 lists -->
      <section class="board">
        <div class="list">
          <div class="list-header todo"><i class="fas fa-list"></i> Todo</div>
          <div class="list-content" id="list-content-todo">No tasks yet.</div>
        </div>
        <div class="list">
          <div class="list-header progress"><i class="fas fa-spinner"></i> en progres</div>
          <div class="list-content" id="list-content-progress">Add tasks to start progress.</div>
        </div>
        <div class="list">
          <div class="list-header verify"><i class="fas fa-search"></i> en verification</div>
          <div class="list-content" id="list-content-verify">Awaiting review.</div>
        </div>
        <div class="list">
          <div class="list-header done"><i class="fas fa-check"></i> terminee</div>
          <div class="list-content" id="list-content-done">Completed tasks appear here.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Member Sidebar -->
  <aside class="sidebar" id="memberSidebar">
    <div class="sidebar-header">
      <h3 class="sidebar-title">Project Members</h3>
      <i class="fas fa-times sidebar-close" id="closeSidebar"></i>
    </div>
    <div class="sidebar-search">
      <input type="text" id="memberSearch" placeholder="Search members...">
    </div>
    <div class="sidebar-content">
      <ul class="member-list" id="memberList">
        <!-- Member items will be injected here -->
      </ul>
    </div>
  </aside>

  <!-- Chat Sidebar -->
  <aside class="chat-sidebar" id="chatSidebar">
    <div class="chat-header">
      <h3 class="chat-title">Project Chat</h3>
      <i class="fas fa-times chat-close" id="closeChat"></i>
    </div>
    <div class="chat-messages" id="chatMessages">
      <ul class="message-list" id="messageList">
        <!-- Messages will be injected here -->
      </ul>
    </div>
    <form class="chat-input-form" id="chatForm">
      <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." autocomplete="off" />
      <button type="submit" class="btn btn-primary icon-btn send-btn" id="sendMsgBtn"><i class="fas fa-paper-plane"></i></button>
    </form>
  </aside>

  <!-- Edit Project Dialog -->
  <div class="dialog-backdrop" id="editDialog">
    <div class="dialog">
      <div class="dialog-header">
        <h3 class="dialog-title">Edit Project</h3>
        <i class="fas fa-times dialog-close" id="closeEditDialog"></i>
      </div>
      <form id="editProjectForm" class="dialog-form">
        <div class="form-group">
          <label for="editProjectName">Project Name</label>
          <input type="text" id="editProjectName" class="form-control" required />
        </div>
        <div class="form-group">
          <label for="editProjectDesc">Description</label>
          <textarea id="editProjectDesc" class="form-control" rows="3"></textarea>
        </div>
        <div class="dialog-actions">
          <button type="button" class="btn" id="cancelEdit">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Task Dialog -->
  <div class="dialog-backdrop" id="createTaskDialog">
    <div class="dialog">
      <div class="dialog-header">
        <h3 class="dialog-title">Create New Task</h3>
        <i class="fas fa-times dialog-close" id="closeCreateTaskDialog"></i>
      </div>
      <form id="createTaskForm" class="dialog-form">
        <div class="form-group">
          <label for="taskTitle">Task Title</label>
          <input type="text" id="taskTitle" class="form-control" placeholder="Enter task title" required />
        </div>
        <div class="form-group">
          <label for="taskDescription">Description</label>
          <textarea id="taskDescription" class="form-control" rows="3" placeholder="Enter task description"></textarea>
        </div>
        <div class="form-group">
          <label for="taskDeadline">Deadline</label>
          <input type="datetime-local" id="taskDeadline" class="form-control" required />
        </div>
        <div class="form-group">
          <label for="taskPriority">Priority</label>
          <select id="taskPriority" class="form-control" required>
            <option value="">Select priority</option>
            <option value="1">Low (1)</option>
            <option value="2">Medium (2)</option>
            <option value="3">High (3)</option>
          </select>
        </div>
        <div class="dialog-actions">
          <button type="button" class="btn" id="cancelCreateTask">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Task</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Task Details Sidebar -->
  <aside class="task-details-sidebar" id="taskDetailsSidebar" style="position: fixed;">
    <div class="task-details-header">
      <h3 class="task-details-title">Task Details</h3>
      <div class="task-details-header-actions">
        <i class="fas fa-trash task-delete-btn" id="deleteTaskBtn" title="Delete task"></i>
        <i class="fas fa-edit edit-icon" id="editTaskIcon" title="Edit task"></i>
        <i class="fas fa-times task-details-close" id="closeTaskDetails"></i>
      </div>
    </div>
    <div class="task-details-body">
      <div class="task-details-left">
        <div class="task-field">
          <div class="task-field-label">Title</div>
          <div class="task-field-value" id="taskDetailTitle"></div>
          <input type="text" class="task-field-input" id="taskDetailTitleInput" style="display: none;" />
        </div>

        <div class="task-field">
          <div class="task-field-label">Description</div>
          <div class="task-field-value" id="taskDetailDescription"></div>
          <textarea class="task-field-textarea" id="taskDetailDescriptionInput" style="display: none;"></textarea>
        </div>

        <div class="task-field">
          <div class="task-field-label">Deadline</div>
          <div class="task-field-value" id="taskDetailDeadline"></div>
          <input type="datetime-local" class="task-field-input" id="taskDetailDeadlineInput" style="display: none;" />
        </div>

        <div class="task-field">
          <div class="task-field-label">Priority</div>
          <div class="task-field-value" id="taskDetailPriority"></div>
          <select class="task-field-input" id="taskDetailPriorityInput" style="display: none;">
            <option value="1">Low</option>
            <option value="2">Medium</option>
            <option value="3">High</option>
          </select>
        </div>

        <div class="task-field">
          <div class="task-field-label">State</div>
          <div class="task-field-value" id="taskDetailState"></div>
        </div>

        <div class="task-field">
          <div class="task-field-label">Author</div>
          <div class="task-field-value" id="taskDetailAuthor"></div>
        </div>

        <div class="task-field">
          <div class="task-field-label">Assigned Members</div>
          <div class="task-field-value" id="taskDetailAssignees" style="display: flex; flex-wrap: wrap; gap: 8px;">
            <!-- Assigned members will be displayed here -->
          </div>
        </div>

        <div class="task-actions" id="taskEditActions" style="display: none;">
          <button class="btn-save" id="saveTaskBtn">Save Changes</button>
          <button class="btn-cancel" id="cancelTaskEditBtn">Cancel</button>
        </div>
      </div>

      <!-- Right Panel: Assignment Section -->
      <div class="task-details-right">
        <div class="assignment-header">
          <h4>ASSIGN MEMBERS</h4>
        </div>
        <div class="assignment-list" id="assignmentList">
          <!-- Member checkboxes will be injected here -->
        </div>
        <div class="assignment-footer">
          <button class="btn-assign" id="confirmAssignBtn">Update Assignments</button>
        </div>
      </div>
    </div>
  </aside>

  <script src="toast.js"></script>
  <script src="fetch.js"></script>
  <script>
    // Read projectid from query and fetch project info
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const projectId = params.get('projectid');
      if (!projectId) {
        notify('No project id provided');
        return;
      }

      let projectData = null;
      let projectMembers = []; // Cache for members
      let chatMessages = []; // Cache for chat messages
      let chatInterval = null; // To hold the interval ID
      let projectTasks = []; // Cache for tasks
      let currentUser = null; // Cache for the current user's profile

      try {
        const { ok: profileOk, data: profileData } = await getUserProfileproject();
        if (profileOk) {
          currentUser = profileData;
        }
      } catch (e) {
        console.error('Could not fetch user profile', e);
      }

      try {
        const { ok, data, message } = await getProject(projectId);
        if (!ok || !data) {
          notify(message || 'Unable to load project');
          return;
        }
        projectData = data; // Store project data
        // Fill sidebar
        document.getElementById('pTitle').textContent = data.nom || 'Projet';
        document.getElementById('pDesc').textContent = data.description || '—';
        document.getElementById('pAuthor').textContent = `Auteur: ${data.createurNom || '—'}`;
        document.getElementById('pCode').textContent = `Join Code: ${projectId}`;
        // Format date d/m/y
        const iso = data.dateCreation;
        if (iso) {
          const d = new Date(iso);
          const day = String(d.getDate()).padStart(2, '0');
          const month = String(d.getMonth() + 1).padStart(2, '0');
          const year = d.getFullYear();
          document.getElementById('pDate').textContent = `Créé le: ${day}/${month}/${year}`;
        }
      } catch (e) {
        notify('Error loading project');
      }

      // Task rendering logic
      const priorityColors = {
        1: '#10b981', // Low
        2: '#4361ee', // Medium
        3: '#f97316'  // High
      };

      const taskColumns = {
        'Todo': document.getElementById('list-content-todo'),
        'en progres': document.getElementById('list-content-progress'),
        'en verification': document.getElementById('list-content-verify'),
        'terminee': document.getElementById('list-content-done')
      };

      const renderTasks = () => {
        // Clear all columns
        Object.values(taskColumns).forEach(col => {
          col.innerHTML = '';
        });

        // Sort tasks by priority descending (3=High, 2=Medium, 1=Low)
        const sortedTasks = [...projectTasks].sort((a, b) => b.priorite - a.priorite);

        sortedTasks.forEach(task => {
          const column = taskColumns[task.etat];
          if (!column) return;

          const card = document.createElement('div');
          card.className = 'task-card';
          card.draggable = true;
          card.dataset.taskId = task.id;
          card.style.borderLeftColor = priorityColors[task.priorite] || '#ccc';
          
          const deadline = new Date(task.deadline);
          const deadlineFormatted = `${String(deadline.getDate()).padStart(2, '0')}/${String(deadline.getMonth() + 1).padStart(2, '0')}/${deadline.getFullYear()}`;

          card.innerHTML = `
            <div class="task-title">${task.titre}</div>
            <div class="task-deadline">Deadline: ${deadlineFormatted}</div>
          `;
          column.appendChild(card);
        });

        // Add placeholder if a column is empty
        Object.values(taskColumns).forEach(col => {
          if (col.children.length === 0) {
            col.textContent = 'No tasks in this stage.';
            col.style.color = 'var(--text-light)';
          }
        });
      };

      // Fetch tasks
      try {
        const { ok, data, message } = await getProjectTasks(projectId);
        if (ok) {
          projectTasks = data || [];
          renderTasks();
        } else {
          notify(message || 'Could not load tasks');
        }
      } catch (e) {
        notify('Error loading tasks');
      }

      // Task Details Sidebar
      const taskDetailsSidebar = document.getElementById('taskDetailsSidebar');
      const closeTaskDetails = document.getElementById('closeTaskDetails');
      const editTaskIcon = document.getElementById('editTaskIcon');
      const taskEditActions = document.getElementById('taskEditActions');
      const saveTaskBtn = document.getElementById('saveTaskBtn');
      const cancelTaskEditBtn = document.getElementById('cancelTaskEditBtn');

      let currentTaskId = null;
      let isEditingTask = false;

      const openTaskDetails = async (taskId) => {
        currentTaskId = taskId;
        const task = projectTasks.find(t => String(t.id) === String(taskId));
        if (!task) return;

        // Load members if not already loaded
        if (projectMembers.length === 0) {
          const { ok, data } = await getProjectMembers(projectId);
          if (ok && data) {
            projectMembers = data;
          }
        }

        // Populate task details
        document.getElementById('taskDetailTitle').textContent = task.titre || 'No title';
        document.getElementById('taskDetailTitleInput').value = task.titre || '';
        
        document.getElementById('taskDetailDescription').textContent = task.description || 'No description';
        document.getElementById('taskDetailDescriptionInput').value = task.description || '';
        
        const deadlineDate = new Date(task.deadline);
        const deadlineFormatted = `${String(deadlineDate.getDate()).padStart(2, '0')}/${String(deadlineDate.getMonth() + 1).padStart(2, '0')}/${deadlineDate.getFullYear()} ${String(deadlineDate.getHours()).padStart(2, '0')}:${String(deadlineDate.getMinutes()).padStart(2, '0')}`;
        document.getElementById('taskDetailDeadline').textContent = deadlineFormatted;
        
        // Set datetime-local value (format: YYYY-MM-DDTHH:mm)
        const deadlineISO = deadlineDate.toISOString().slice(0, 16);
        document.getElementById('taskDetailDeadlineInput').value = deadlineISO;
        
        // State badge
        const stateBadgeClass = {
          'Todo': 'task-state-todo',
          'en progres': 'task-state-progress',
          'en verification': 'task-state-verify',
          'terminee': 'task-state-done'
        }[task.etat] || 'task-state-todo';
        document.getElementById('taskDetailState').innerHTML = `<span class="task-state-badge ${stateBadgeClass}">${task.etat}</span>`;
        
        // Priority badge
        const priorityLabels = { 1: 'Low', 2: 'Medium', 3: 'High' };
        const priorityBadgeClass = `task-priority-${task.priorite}`;
        document.getElementById('taskDetailPriority').innerHTML = `<span class="task-priority-badge ${priorityBadgeClass}">${priorityLabels[task.priorite] || task.priorite}</span>`;
        document.getElementById('taskDetailPriorityInput').value = String(task.priorite);
        
        document.getElementById('taskDetailAuthor').textContent = task.auteur || 'Unknown';

        // Display assigned members
        const taskDetailAssignees = document.getElementById('taskDetailAssignees');
        taskDetailAssignees.innerHTML = '';
        if (task.assignees && task.assignees.length > 0) {
          task.assignees.forEach(assignee => {
            const initials = `${(assignee.prenom || '?').charAt(0)}${(assignee.nom || '?').charAt(0)}`.toUpperCase();
            const assigneeItem = document.createElement('div');
            assigneeItem.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: #f0f4ff; border-radius: 20px; font-size: 0.85rem;';
            assigneeItem.innerHTML = `
              <div style="width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.7rem;">${initials}</div>
              <span style="color: var(--text-dark); font-weight: 500;">${assignee.prenom || ''} ${assignee.nom || ''}</span>
            `;
            taskDetailAssignees.appendChild(assigneeItem);
          });
        } else {
          taskDetailAssignees.innerHTML = '<span style="color: var(--text-light); font-size: 0.85rem;">No members assigned</span>';
        }

        // Populate assignment list with only unassigned members
        const assignedUserIds = new Set(
          (task.assignees || []).map(assignee => parseInt(assignee.id))
        );

        assignmentList.innerHTML = '';
        const unassignedMembers = projectMembers.filter(member => 
          !assignedUserIds.has(parseInt(member.id))
        );
        
        if (unassignedMembers.length === 0) {
          assignmentList.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--text-light); font-size: 0.85rem;">All members are already assigned</p>';
          confirmAssignBtn.disabled = true;
        } else {
          confirmAssignBtn.disabled = false;
          unassignedMembers.forEach(member => {
            const item = document.createElement('div');
            item.className = 'assignment-item';
            const initials = `${(member.prenom || '?').charAt(0)}${(member.nom || '?').charAt(0)}`.toUpperCase();
            item.innerHTML = `
              <input type="checkbox" class="assignment-checkbox" data-user-id="${member.id}" />
              <div class="assignment-avatar">${initials}</div>
              <div class="assignment-name">${member.prenom || ''} ${member.nom || ''}</div>
            `;
            assignmentList.appendChild(item);
          });
        }

        taskDetailsSidebar.classList.add('open');
      };

      const closeTaskDetailsSidebar = () => {
        taskDetailsSidebar.classList.remove('open');
        if (isEditingTask) {
          cancelTaskEdit();
        }
      };

      const enableTaskEdit = () => {
        isEditingTask = true;
        
        // Hide values, show inputs
        document.getElementById('taskDetailTitle').style.display = 'none';
        document.getElementById('taskDetailTitleInput').style.display = 'block';
        
        document.getElementById('taskDetailDescription').style.display = 'none';
        document.getElementById('taskDetailDescriptionInput').style.display = 'block';
        
        document.getElementById('taskDetailDeadline').style.display = 'none';
        document.getElementById('taskDetailDeadlineInput').style.display = 'block';
        
        document.getElementById('taskDetailPriority').style.display = 'none';
        document.getElementById('taskDetailPriorityInput').style.display = 'block';
        
        taskEditActions.style.display = 'flex';
        editTaskIcon.style.display = 'none';
      };

      const cancelTaskEdit = () => {
        isEditingTask = false;
        
        // Show values, hide inputs
        document.getElementById('taskDetailTitle').style.display = 'block';
        document.getElementById('taskDetailTitleInput').style.display = 'none';
        
        document.getElementById('taskDetailDescription').style.display = 'block';
        document.getElementById('taskDetailDescriptionInput').style.display = 'none';
        
        document.getElementById('taskDetailDeadline').style.display = 'block';
        document.getElementById('taskDetailDeadlineInput').style.display = 'none';
        
        document.getElementById('taskDetailPriority').style.display = 'block';
        document.getElementById('taskDetailPriorityInput').style.display = 'none';
        
        taskEditActions.style.display = 'none';
        editTaskIcon.style.display = 'inline';
      };

      const saveTaskChanges = async () => {
        const titre = document.getElementById('taskDetailTitleInput').value.trim();
        const description = document.getElementById('taskDetailDescriptionInput').value.trim();
        const deadline = document.getElementById('taskDetailDeadlineInput').value;
        const priorite = parseInt(document.getElementById('taskDetailPriorityInput').value);

        if (!titre || !deadline) {
          notify('❌ Title and deadline are required');
          return;
        }

        const deadlineISO = new Date(deadline).toISOString();

        if (typeof window.showLoading === 'function') {
          window.showLoading('Updating task...');
        }

        try {
          const { ok, data, message } = await updateTask(currentTaskId, { titre, description, deadline: deadlineISO, priorite });
          
          if (typeof window.hideLoading === 'function') {
            window.hideLoading();
          }

          if (ok) {
            notify('✅ Task updated successfully');
            
            // Update local cache
            const taskIndex = projectTasks.findIndex(t => String(t.id) === String(currentTaskId));
            if (taskIndex !== -1 && data) {
              projectTasks[taskIndex] = { ...projectTasks[taskIndex], ...data };
            }
            
            // Re-render tasks
            renderTasks();
            
            // Close edit mode and update displayed values
            cancelTaskEdit();
            openTaskDetails(currentTaskId);
          } else {
            notify('❌ ' + (message || 'Failed to update task'));
          }
        } catch (error) {
          if (typeof window.hideLoading === 'function') {
            window.hideLoading();
          }
          console.error('Error updating task:', error);
          notify('❌ An error occurred while updating the task');
        }
      };

      const deleteTaskHandler = async () => {
        if (!confirm('Are you sure you want to delete this task?')) {
          return;
        }

        if (typeof window.showLoading === 'function') {
          window.showLoading('Deleting task...');
        }

        try {
          const { ok, message } = await deleteTask(currentTaskId);
          
          if (typeof window.hideLoading === 'function') {
            window.hideLoading();
          }

          if (ok) {
            notify('✅ Task deleted successfully');
            
            // Remove from local cache
            projectTasks = projectTasks.filter(t => String(t.id) !== String(currentTaskId));
            
            // Re-render tasks
            renderTasks();
            
            // Close sidebar
            closeTaskDetailsSidebar();
          } else {
            notify('❌ ' + (message || 'Failed to delete task'));
          }
        } catch (error) {
          if (typeof window.hideLoading === 'function') {
            window.hideLoading();
          }
          console.error('Error deleting task:', error);
          notify('❌ An error occurred while deleting the task');
        }
      };

      // Assignment Panel
      const assignmentList = document.getElementById('assignmentList');
      const confirmAssignBtn = document.getElementById('confirmAssignBtn');

      const assignSelectedMembers = async () => {
        const checkboxes = assignmentList.querySelectorAll('.assignment-checkbox');
        const selectedUserIds = [];
        
        checkboxes.forEach(cb => {
          if (cb.checked) {
            selectedUserIds.push(parseInt(cb.dataset.userId));
          }
        });

        if (selectedUserIds.length === 0) {
          notify('❌ Please select at least one member');
          return;
        }

        if (typeof window.showLoading === 'function') {
          window.showLoading('Updating assignments...');
        }

        try {
          const { ok, message } = await assignTaskMembers(currentTaskId, selectedUserIds);
          
          if (typeof window.hideLoading === 'function') {
            window.hideLoading();
          }

          if (ok) {
            notify('✅ Members assigned successfully');
            
            // Update local cache with selected members
            const taskIndex = projectTasks.findIndex(t => String(t.id) === String(currentTaskId));
            if (taskIndex !== -1) {
              const selectedMembers = projectMembers.filter(m => 
                selectedUserIds.includes(parseInt(m.id))
              );
              projectTasks[taskIndex].assignees = selectedMembers;
            }
            
            // Refresh display
            openTaskDetails(currentTaskId);
          } else {
            notify('❌ ' + (message || 'Failed to assign members'));
          }
        } catch (error) {
          if (typeof window.hideLoading === 'function') {
            window.hideLoading();
          }
          console.error('Error assigning members:', error);
          notify('❌ An error occurred while assigning members');
        }
      };

      confirmAssignBtn.addEventListener('click', assignSelectedMembers);

      closeTaskDetails.addEventListener('click', closeTaskDetailsSidebar);
      editTaskIcon.addEventListener('click', enableTaskEdit);
      cancelTaskEditBtn.addEventListener('click', cancelTaskEdit);
      saveTaskBtn.addEventListener('click', saveTaskChanges);
      document.getElementById('deleteTaskBtn').addEventListener('click', deleteTaskHandler);

      // Add click event to task cards
      document.addEventListener('click', (e) => {
        const taskCard = e.target.closest('.task-card');
        if (taskCard && !taskCard.classList.contains('dragging')) {
          const taskId = taskCard.dataset.taskId;
          if (taskId) {
            openTaskDetails(taskId);
          }
        }
      });

      // Sidebar elements and logic
      const memberSidebar = document.getElementById('memberSidebar');
      const memberList = document.getElementById('memberList');
      const closeSidebar = document.getElementById('closeSidebar');
      const memberSearch = document.getElementById('memberSearch');

      const renderMembers = (filter = '') => {
        if (!projectData) return;
        memberList.innerHTML = ''; // Clear previous list

        const lowerCaseFilter = filter.toLowerCase();
        const filteredMembers = projectMembers.filter(member =>
          (member.nom && member.nom.toLowerCase().includes(lowerCaseFilter)) ||
          (member.prenom && member.prenom.toLowerCase().includes(lowerCaseFilter))
        );

        // --- Sorting Logic ---
        const authorFullName = projectData.createurNom;
        // Try both name orders for author matching
        const author = filteredMembers.find(m => 
          `${m.prenom} ${m.nom}` === authorFullName || 
          `${m.nom} ${m.prenom}` === authorFullName ||
          m.id === projectData.createurId
        );
        
        // Match current user by email for reliability
        const me = currentUser ? filteredMembers.find(m => 
          m.email === currentUser.email ||
          (m.nom === currentUser.nom && m.prenom === currentUser.prenom) ||
          m.id === currentUser.id
        ) : null;

        // Filter out author and current user to get the rest
        const otherMembers = filteredMembers.filter(m => {
            const isAuthor = author && m.id === author.id;
            const isMe = me && m.id === me.id;
            return !isAuthor && !isMe;
        });

        // Build the sorted list, ensuring author is first, then current user
        const sortedMembers = [];
        if (author) {
            sortedMembers.push(author);
        }
        if (me && (!author || me.id !== author.id)) {
            sortedMembers.push(me);
        }
        sortedMembers.push(...otherMembers);

        const canCurrentUserKick = me && author && me.id === author.id;

        sortedMembers.forEach(member => {
          const isAuthor = author && member.id === author.id;
          const isCurrentUser = me && member.id === me.id;
          const li = document.createElement('li');
          li.className = 'member-item';

          let kickButtonHtml = '';
          if (canCurrentUserKick && !isAuthor && !isCurrentUser) {
            kickButtonHtml = `<button class="kick-btn" data-member-id="${member.id}">Kick</button>`;
          }

          li.innerHTML = `
            <div class="member-avatar">${(member.prenom || '?').charAt(0)}${(member.nom || '?').charAt(0)}</div>
            <div class="member-info">
              <div class="member-name">${member.prenom || ''} ${member.nom || 'Unknown'}${isCurrentUser ? ' (me)' : ''}</div>
              <div class="member-role">${isAuthor ? 'Author' : 'Member'}</div>
            </div>
            ${isAuthor ? '<span class="author-tag">Author</span>' : kickButtonHtml}
          `;
          memberList.appendChild(li);
        });
      };

      closeSidebar.addEventListener('click', () => memberSidebar.classList.remove('open'));
      memberSearch.addEventListener('input', (e) => renderMembers(e.target.value));

      // Chat sidebar elements and logic
      const chatSidebar = document.getElementById('chatSidebar');
      const messageList = document.getElementById('messageList');
      const chatMessagesContainer = document.getElementById('chatMessages');
      const closeChat = document.getElementById('closeChat');
      const chatForm = document.getElementById('chatForm');
      const chatInput = document.getElementById('chatInput');

      const renderMessages = () => {
        messageList.innerHTML = '';
        chatMessages.forEach(msg => {
          const li = document.createElement('li');
          li.className = 'message-item';
          const d = new Date(msg.dateEnvoi);
          const time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

          li.innerHTML = `
            <div class="message-avatar">${(msg.author || '?').split(' ').map(n => n[0]).join('')}</div>
            <div class="message-content">
              <span class="message-author">${msg.author}</span>
              <p class="message-text">${msg.contenu}</p>
              <span class="message-date">${time}</span>
            </div>
          `;
          messageList.appendChild(li);
        });
        // Scroll to bottom
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
      };

      const fetchMessages = async () => {
        if (!projectData || !projectData.chatId) return;
        const { ok, data } = await getChatMessages(projectData.chatId);
        if (ok) {
          chatMessages = data || [];
          renderMessages();
        }
      };

      closeChat.addEventListener('click', () => {
        chatSidebar.classList.remove('open');
        if (chatInterval) clearInterval(chatInterval); // Stop polling
      });

      chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = chatInput.value.trim();
        if (!content || !projectData || !projectData.chatId) return;

        chatInput.disabled = true;
        const { ok, data } = await sendMessage(projectData.chatId, content);
        chatInput.disabled = false;

        if (ok) {
          chatInput.value = '';
          await fetchMessages(); // Refresh messages immediately
        } else {
          notify('Failed to send message');
        }
      });

      // Edit Dialog logic
      const editDialog = document.getElementById('editDialog');
      const editProjectForm = document.getElementById('editProjectForm');
      const editProjectName = document.getElementById('editProjectName');
      const editProjectDesc = document.getElementById('editProjectDesc');
      const closeEditDialog = document.getElementById('closeEditDialog');
      const cancelEdit = document.getElementById('cancelEdit');
      const btnEdit = document.getElementById('btnEdit');

      btnEdit.addEventListener('click', () => {
        if (!projectData) return;
        // Populate form with current data
        editProjectName.value = projectData.nom;
        editProjectDesc.value = projectData.description;
        editDialog.classList.add('open');
      });

      const closeDialog = () => editDialog.classList.remove('open');
      closeEditDialog.addEventListener('click', closeDialog);
      cancelEdit.addEventListener('click', closeDialog);

      editProjectForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newName = editProjectName.value.trim();
        const newDesc = editProjectDesc.value.trim();

        if (!newName) return notify('Project name cannot be empty');

        const { ok, data, message } = await updateProject(projectId, { nom: newName, description: newDesc });

        if (ok) {
          // Update local data and UI
          projectData.nom = data.nom;
          projectData.description = data.description;
          document.getElementById('pTitle').textContent = data.nom;
          document.getElementById('pDesc').textContent = data.description;
          notify('Project updated successfully');
          closeDialog();
        } else {
          notify(message || 'Failed to update project');
        }
      });

      // Create Task Dialog
      const createTaskDialog = document.getElementById('createTaskDialog');
      const closeCreateTaskDialog = document.getElementById('closeCreateTaskDialog');
      const cancelCreateTask = document.getElementById('cancelCreateTask');
      const createTaskForm = document.getElementById('createTaskForm');
      const taskTitle = document.getElementById('taskTitle');
      const taskDescription = document.getElementById('taskDescription');
      const taskDeadline = document.getElementById('taskDeadline');
      const taskPriority = document.getElementById('taskPriority');

      const openCreateTaskDialog = () => createTaskDialog.classList.add('open');
      const closeTaskDialog = () => {
        createTaskDialog.classList.remove('open');
        createTaskForm.reset();
      };

      closeCreateTaskDialog.addEventListener('click', closeTaskDialog);
      cancelCreateTask.addEventListener('click', closeTaskDialog);

      createTaskForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Create task form submitted');
        
        const titre = taskTitle.value.trim();
        const description = taskDescription.value.trim();
        const deadline = taskDeadline.value;
        const priorite = parseInt(taskPriority.value);

        console.log('Form values:', { titre, description, deadline, priorite, projectId });

        if (!titre) {
          notify('❌ Please enter a task title');
          return;
        }

        if (!deadline) {
          notify('❌ Please select a deadline');
          return;
        }

        if (!priorite || isNaN(priorite)) {
          notify('❌ Please select a priority');
          return;
        }

        if (!projectId) {
          notify('❌ Project ID not available');
          return;
        }

        // Convert datetime-local to ISO format
        const deadlineISO = new Date(deadline).toISOString();
        console.log('Deadline ISO:', deadlineISO);

        if (typeof window.showLoading === 'function') {
          window.showLoading('Creating task...');
        }
        
        try {
          console.log('Calling createTask...');
          const { ok, data, message } = await createTask(projectId, titre, description, deadlineISO, priorite);
          console.log('createTask response:', { ok, data, message });
          
          if (typeof window.hideLoading === 'function') {
            window.hideLoading();
          }
          
          if (ok) {
            notify('✅ Task created successfully');
            closeTaskDialog();
            // Reload tasks to show the new one
            const { ok: tasksOk, data: tasksData } = await getProjectTasks(projectId);
            if (tasksOk) {
              projectTasks = tasksData || [];
              renderTasks();
            }
          } else {
            notify('❌ ' + (message || 'Failed to create task'));
          }
        } catch (error) {
          if (typeof window.hideLoading === 'function') {
            window.hideLoading();
          }
          console.error('Error creating task:', error);
          notify('❌ An error occurred while creating the task');
        }
      });

      // Header controls interactions
      const btnCreate = document.getElementById('btnCreateTask');
      const btnMembers = document.getElementById('btnMembers');
      const btnChat = document.getElementById('btnChat');
      
      btnCreate.addEventListener('click', openCreateTaskDialog);

      btnMembers.addEventListener('click', async () => {
        if (!projectId) return;

        if (projectMembers.length === 0) {
          // Fetch only if cache is empty
          const { ok, data, message } = await getProjectMembers(projectId);
          if (!ok) return notify(message || 'Unable to load members');
          projectMembers = data || []; // Cache the members
        }
        
        renderMembers(); // Initial render with no filter
        memberSidebar.classList.add('open');
      });

      btnChat.addEventListener('click', async () => {
        if (!projectData || !projectData.chatId) {
          return notify('Chat not available for this project.');
        }
        
        await fetchMessages(); // Initial fetch
        chatSidebar.classList.add('open');
        
        // Start polling every 5 seconds
        if (chatInterval) clearInterval(chatInterval);
        chatInterval = setInterval(fetchMessages, 5000);
      });

      // Event delegation for kick buttons
      memberList.addEventListener('click', async (e) => {
        if (e.target.classList.contains('kick-btn')) {
          const memberId = e.target.dataset.memberId;
          if (!memberId) return;

          // Confirmation before kicking
          if (!confirm('Are you sure you want to kick this member?')) return;

          const { ok, message } = await kickMember(projectId, memberId);
          notify(message || 'Action completed');

          if (ok) {
            // Remove member from cache and re-render
            projectMembers = projectMembers.filter(m => String(m.id) !== memberId);
            renderMembers();
          }
        }
      });

      // Drag and Drop for Tasks
      const board = document.querySelector('.board');
      let draggedTaskId = null;

      board.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('task-card')) {
          draggedTaskId = e.target.dataset.taskId;
          // Add a class to the dragged element for visual feedback
          setTimeout(() => e.target.classList.add('dragging'), 0);
        }
      });

      board.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('task-card')) {
          e.target.classList.remove('dragging');
          draggedTaskId = null;
        }
      });

      Object.entries(taskColumns).forEach(([state, columnEl]) => {
        columnEl.addEventListener('dragover', (e) => {
          e.preventDefault(); // Allow dropping
          columnEl.classList.add('drag-over');
        });

        columnEl.addEventListener('dragleave', () => {
          columnEl.classList.remove('drag-over');
        });

        columnEl.addEventListener('drop', async (e) => {
          e.preventDefault();
          columnEl.classList.remove('drag-over');
          if (!draggedTaskId) return;

          const newState = state;
          const task = projectTasks.find(t => String(t.id) === draggedTaskId);
          if (!task || task.etat === newState) return;

          const oldState = task.etat;

          // Optimistically update the UI
          task.etat = newState;
          renderTasks();

          // Call the API to update the state
          const { ok, message } = await updateTaskState(draggedTaskId, newState);

          if (!ok) {
            // If the API call fails, revert the change in the UI
            task.etat = oldState;
            renderTasks();
            notify(message || 'Failed to update task status.');
          } else {
            notify('Task status updated!');
          }
        });
      });
    });
  </script>
</body>
</html>
